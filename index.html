<html>
	<head>
		<title>github.andrewt.net / majority</title>
		<style type="text/css">
			label::after {
				content: ': ';
			}
		</style>
	</head>
	<body>
		<ul id="parties"></ul>
		<div>Everyone else: <span id="others"></span></div>
		<div>
			<label for="majority">Seats needed to govern</label>
			<input id="majority" name="majority" type="number" value="326">
		</div>
		<h1>Majorities</h1>
		<ul id="majorities"></ul>
		<script type="text/javascript">
			var pList = document.getElementById('parties'),
				mList = document.getElementById('majorities'),
				others = document.getElementById('others'),
				mBox = document.getElementById('majority'),
				n = 1;
			function addParty(name, colour, seats) {
				var li = document.createElement('li');
				li.id = 'party-' + n;
				li.innerHTML = box('name', 'text', name) +
					box('colour', 'text', colour) +
					box('seats', 'number', seats);
				pList.appendChild(li);
				var cBox = document.getElementById('colour-' + n);
				cBox.addEventListener('input', colourCBox);
				colourCBox();
				document.getElementById('seats-' + n)
					.addEventListener('input', majoritise);
				document.getElementById('name-' + n)
					.addEventListener('input', function() {
						for (var i = 1; i < n; ++i)
							if (!document.getElementById('name-' + i).value)
								return;
						addParty();
					});
				++n;
				function colourCBox() {
					cBox.style.color = cBox.value;
				};
			}
			function box(label, type, value) {
				var id = label.replace(/ /g, '') + '-' + n;
				return '<label for="' + id + '">' + label + '</label>' +
					'<input id="' + id +
						'" name="' + id +
						'" value="' + (value || '') +
						'" type="' + (type || 'text') + '">';
			}
			addParty('Labour', 'red');
			addParty('Conservatives', 'blue');
			addParty('Lib Dems', '#f80');
			addParty('Greens', '#4d4');
			addParty('UKIP', 'purple');
			addParty('SNP', '#dd0');
			addParty('Plaid Cymru', 'green');
			addParty();
			majoritise();
			mBox.addEventListener('input', majoritise);
			function majoritise() {
				mList.innerHTML = '';
				var parties = [];
				for (var i = 1; i < n - 1; ++i)
					parties.push(read(['name', 'colour', 'seats'], i));
				parties = parties.sort(function(a, b) {
					return b.seats - a.seats;
				}).filter(function(a) { return a.name; });
				var seats = countSeats(parties);
				if (seats < 650) {
					parties.push({
						name: 'Everyone else',
						colour: 'gray',
						seats: 650 - seats
					});
				}
				others.innerHTML = 650 - seats;
				var majority = parseFloat(mBox.value);
				build([]);
				function build(pre) {
					parties.forEach(function(next) {
						if (next.seats &&
							(!pre.length || next.seats <= pre[pre.length - 1].seats) &&
							!~pre.indexOf(next)) {
							var now = pre.slice();
							now.push(next);
							var seats = countSeats(now);
							if (seats >= majority) {
								var li = document.createElement('li');
								li.innerHTML = now.map(function(x) {
									return '<span style="color: ' + x.colour + '">' + x.name + '</span>';
								}).join(' + ') + ' = ' + seats;
								mList.appendChild(li);
							} else build(now);
						}
					});
				}
			}
			function countSeats(parties) {
				var seats = 0;
				parties.forEach(function(x) { seats += x.seats; });
				return seats;
			}
			function read(p, i) {
				var x = {};
				p.forEach(function(k) {
					var j = document.getElementById(k + '-' + i);
					x[k] = (j.type == 'number') ? parseFloat(j.value || '0') : j.value;
				});
				return x;
			}
		</script>
	</body>
</html>	